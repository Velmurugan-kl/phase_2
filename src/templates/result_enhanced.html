<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LungAI ‚Äî Prediction Result</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .result-layout {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1024px) {
      .result-layout { grid-template-columns: 1fr; }
    }

    /* X-ray viewer */
    .xray-viewer {
      background: #000;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--navy-border);
      position: relative;
    }

    .xray-viewer img {
      width: 100%;
      display: block;
      filter: brightness(0.95) contrast(1.05);
    }

    .xray-overlay {
      position: absolute;
      top: 12px; left: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .xray-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      font-size: 0.72rem;
      font-family: var(--font-mono);
      color: rgba(255,255,255,0.8);
      backdrop-filter: blur(4px);
    }

    /* Prediction rows */
    .pred-list { display: flex; flex-direction: column; gap: 10px; }

    .pred-item {
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--navy-border);
      background: rgba(255,255,255,0.02);
      transition: var(--transition);
    }

    .pred-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); }

    .pred-item.top-pred {
      background: var(--teal-glow);
      border-color: var(--teal-border);
    }

    .pred-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 9px;
    }

    .pred-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--white);
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .pred-pct {
      font-family: var(--font-mono);
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--teal-light);
    }

    .pred-item.top-pred .pred-pct { color: var(--teal-light); }

    /* Doctor feedback */
    .feedback-panel {
      border: 1px solid var(--navy-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-top: 24px;
    }

    .feedback-panel-header {
      padding: 18px 22px;
      background: rgba(245,158,11,0.06);
      border-bottom: 1px solid rgba(245,158,11,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feedback-panel-header h4 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--white);
    }

    .feedback-panel-body { padding: 22px; }

    .verdict-row {
      display: flex;
      gap: 12px;
      margin-bottom: 0;
    }

    /* Correction form */
    .correction-box {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--navy-border);
    }

    .correction-box.open { display: block; }

    .class-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    @media (max-width: 600px) { .class-grid { grid-template-columns: 1fr; } }

    .class-opt {
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--navy-border);
      background: rgba(255,255,255,0.02);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.875rem;
      color: var(--muted-light);
    }

    .class-opt:hover {
      border-color: var(--teal-border);
      background: var(--teal-glow);
      color: var(--white);
    }

    .class-opt.selected {
      border-color: var(--teal);
      background: rgba(13,148,136,0.12);
      color: var(--white);
    }

    .class-opt .opt-icon {
      width: 28px; height: 28px;
      border-radius: 7px;
      background: rgba(255,255,255,0.05);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
    }

    .class-opt.selected .opt-icon {
      background: var(--teal);
      color: var(--white);
    }

    /* Success state */
    .success-state {
      display: none;
      text-align: center;
      padding: 36px 24px;
    }

    .success-state.show { display: block; }

    .success-icon {
      width: 60px; height: 60px;
      border-radius: 50%;
      background: rgba(16,185,129,0.15);
      border: 2px solid rgba(16,185,129,0.4);
      display: flex; align-items: center; justify-content: center;
      font-size: 26px;
      color: var(--green);
      margin: 0 auto 16px;
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a href="/" class="header-brand" style="text-decoration:none;">
      <div class="brand-icon">ü´Å</div>
      <div>
        <div class="brand-name">LungAI</div>
        <div class="brand-sub">Diagnostic System v2.0</div>
      </div>
    </a>
    <nav class="header-nav">
      <a href="/" class="nav-link"><i class="fas fa-upload"></i> Upload</a>
      <a href="/dashboard" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a>
      <a href="/training_queue" class="nav-link"><i class="fas fa-layer-group"></i> Training Queue</a>
    </nav>
  </div>
</header>

<div class="page-wrapper">

  <div class="page-title-block animate-fade-up">
    <h1>Prediction Result</h1>
    <p>Review the AI analysis and provide your clinical validation below</p>
  </div>

  <div class="result-layout">

    <!-- Left: X-Ray -->
    <div class="animate-fade-up delay-1">
      <div class="xray-viewer">
        <img src="static/uploads/{{ filename }}" alt="X-Ray"/>
        <div class="xray-overlay">
          <span class="xray-tag"><i class="fas fa-hashtag"></i> ID {{ prediction_id }}</span>
          <span class="xray-tag"><i class="fas fa-file-image"></i> {{ filename }}</span>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-body" style="padding:18px 20px;">
          <div style="font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); margin-bottom:12px;">Top Prediction</div>
          <div style="font-size:1.3rem; font-weight:700; color:var(--white); margin-bottom:4px;">{{ pred_class_name }}</div>
          <div style="font-family:var(--font-mono); font-size:0.85rem; color:var(--teal-light);">
            {{ pred_likelihood | round(2) }}% confidence
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Predictions + Feedback -->
    <div class="animate-fade-up delay-2">

      <!-- All predictions -->
      <div class="card mb-6">
        <div class="card-header">
          <i class="fas fa-chart-bar text-teal"></i>
          <h3>Ensemble Predictions</h3>
        </div>
        <div class="card-body">
          <div class="pred-list">
            {% for prediction in predictions %}
            <div class="pred-item {% if loop.first %}top-pred{% endif %}">
              <div class="pred-meta">
                <span class="pred-name">
                  {% if loop.first %}<i class="fas fa-star" style="color:var(--amber); font-size:11px;"></i>{% endif %}
                  {{ prediction.class_name }}
                </span>
                <span class="pred-pct">{{ prediction.confidence | round(2) }}%</span>
              </div>
              <div class="progress-wrap">
                <div class="progress-bar {% if not loop.first %}teal{% endif %}"
                     style="width:{{ prediction.confidence }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Doctor Feedback -->
      <div class="feedback-panel">
        <div class="feedback-panel-header">
          <i class="fas fa-user-md" style="color:var(--amber);"></i>
          <h4>Doctor Validation</h4>
          <span class="badge badge-amber" style="margin-left:auto;">Required</span>
        </div>

        <div class="feedback-panel-body" id="feedbackBody">
          <p style="font-size:0.875rem; color:var(--muted-light); margin-bottom:18px;">
            Is the AI prediction clinically accurate?
          </p>

          <div class="verdict-row">
            <button class="btn btn-success btn-lg" style="flex:1; justify-content:center;" onclick="markCorrect()">
              <i class="fas fa-check-circle"></i> Correct
            </button>
            <button class="btn btn-danger btn-lg" style="flex:1; justify-content:center;" onclick="openCorrection()">
              <i class="fas fa-times-circle"></i> Incorrect
            </button>
          </div>

          <!-- Correction form -->
          <div class="correction-box" id="correctionBox">
            <div style="font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:0.07em; color:var(--muted); margin-bottom:12px;">
              Select correct diagnosis
            </div>

            <div class="class-grid">
              {% for label in class_labels %}
              <div class="class-opt" data-id="{{ loop.index0 }}" data-name="{{ label }}" onclick="selectClass(this)">
                <div class="opt-icon"><i class="fas fa-circle-notch"></i></div>
                <span>{{ label }}</span>
              </div>
              {% endfor %}
            </div>

            <div class="mb-4">
              <label>Doctor Notes (Optional)</label>
              <textarea class="form-control" id="doctorNotes" placeholder="Clinical observations, reasons for correction‚Ä¶"></textarea>
            </div>

            <div class="mb-4">
              <label>Doctor ID (Optional)</label>
              <input type="text" class="form-control" id="doctorId" placeholder="e.g. DR-001"/>
            </div>

            <button class="btn btn-primary btn-lg" style="width:100%; justify-content:center;" onclick="submitCorrection()">
              <i class="fas fa-paper-plane"></i> Submit Correction
            </button>
          </div>
        </div>

        <!-- Success -->
        <div class="success-state" id="successState">
          <div class="success-icon"><i class="fas fa-check"></i></div>
          <h3 style="font-size:1.1rem; margin-bottom:8px;">Feedback Recorded</h3>
          <p style="font-size:0.875rem; color:var(--muted); margin-bottom:24px;" id="successMsg">
            Thank you ‚Äî your input improves the model.
          </p>
          <div style="display:flex; gap:12px; justify-content:center;">
            <a href="/" class="btn btn-primary"><i class="fas fa-upload"></i> New Analysis</a>
            <a href="/dashboard" class="btn btn-ghost"><i class="fas fa-chart-line"></i> Dashboard</a>
          </div>
        </div>

      </div><!-- /feedback-panel -->

    </div>
  </div><!-- /result-layout -->

</div>

<script>
  const predictionId = {{ prediction_id }};
  let selectedClassId   = null;
  let selectedClassName = null;

  function markCorrect() {
    if (!confirm('Confirm: AI prediction is correct?')) return;
    submitFeedback(true, null, null);
  }

  function openCorrection() {
    document.getElementById('correctionBox').classList.add('open');
  }

  function selectClass(el) {
    document.querySelectorAll('.class-opt').forEach(o => {
      o.classList.remove('selected');
      o.querySelector('i').className = 'fas fa-circle-notch';
    });
    el.classList.add('selected');
    el.querySelector('i').className = 'fas fa-check';
    selectedClassId   = parseInt(el.dataset.id);
    selectedClassName = el.dataset.name;
  }

  function submitCorrection() {
    if (selectedClassId === null) {
      alert('Please select the correct diagnosis.');
      return;
    }
    submitFeedback(false, selectedClassId, selectedClassName,
      document.getElementById('doctorNotes').value,
      document.getElementById('doctorId').value || 'anonymous');
  }

  function submitFeedback(isCorrect, cls, clsName, notes = '', docId = 'anonymous') {
    fetch('/submit_feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prediction_id: predictionId,
        is_correct: isCorrect,
        correct_class: cls,
        correct_class_name: clsName,
        doctor_notes: notes,
        doctor_id: docId
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('feedbackBody').style.display = 'none';
        const ss = document.getElementById('successState');
        ss.classList.add('show');
        if (!isCorrect) {
          document.getElementById('successMsg').textContent =
            `Correction recorded ‚Äî ${clsName} added to training queue.`;
        }
      }
    })
    .catch(() => alert('Error submitting feedback. Please try again.'));
  }
</script>
</body>
</html>