<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lung Disease Detection - Doctor Review</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style type="text/css">
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }

      .main-container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 15px;
        margin: 30px auto;
        max-width: 1400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .image-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .image-container img {
        max-width: 100%;
        height: auto;
        max-height: 500px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .prediction-item {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
        background-color: #e9ecef;
        transition: all 0.3s ease;
      }

      .prediction-item:hover {
        transform: translateX(5px);
      }

      .prediction-item.top-prediction {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(23, 162, 184, 0.3);
      }

      .progress {
        height: 25px;
        margin-top: 8px;
        border-radius: 5px;
      }

      .feedback-section {
        background-color: #fff9e6;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 25px;
        margin-top: 30px;
      }

      .feedback-section h4 {
        color: #ff6b6b;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .feedback-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .btn-correct {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .btn-correct:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .btn-incorrect {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .btn-incorrect:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
      }

      .correction-form {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #dee2e6;
      }

      .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }

      .class-option {
        cursor: pointer;
        padding: 12px;
        margin: 8px 0;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .class-option:hover {
        border-color: #17a2b8;
        background-color: #f8f9fa;
      }

      .class-option.selected {
        border-color: #28a745;
        background-color: #d4edda;
      }

      .confidence-badge {
        font-size: 14px;
        padding: 5px 10px;
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.3);
      }

      .doctor-notes {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 14px;
      }

      .submit-feedback-btn {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border: none;
        padding: 12px 40px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-top: 15px;
      }

      .submit-feedback-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }

      .info-badge {
        background-color: #e7f3ff;
        border-left: 4px solid #17a2b8;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="bg-info text-dark py-4">
      <div class="container text-center">
        <h1><i class="fas fa-lungs"></i> Lung Disease Detection - Doctor Review Panel</h1>
      </div>
    </div>

    <div class="container">
      <div class="main-container">
        <div class="row">
          <!-- Left: Image Display -->
          <div class="col-md-5">
            <div class="image-container">
              <h4 class="mb-3"><i class="fas fa-x-ray"></i> X-Ray Image</h4>
              <img src="static/uploads/{{filename}}" class="img-fluid" alt="X-Ray" />
              <div class="info-badge mt-3">
                <small><strong>Prediction ID:</strong> #{{prediction_id}}</small>
              </div>
            </div>
          </div>

          <!-- Right: Predictions & Feedback -->
          <div class="col-md-7">
            <div class="predictions-container">
              <h3 class="mb-4"><i class="fas fa-chart-bar"></i> AI Model Predictions</h3>
              
              <!-- Loop through all predictions -->
              {% for prediction in predictions %}
              <div class="prediction-item {% if loop.first %}top-prediction{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    {% if loop.first %}
                    <i class="fas fa-star"></i>
                    {% endif %}
                    <strong>{{ prediction.class_name }}</strong>
                  </div>
                  <span class="confidence-badge">{{ prediction.confidence | round(2) }}%</span>
                </div>
                <div class="progress">
                  <div 
                    class="progress-bar {% if loop.first %}bg-dark{% else %}bg-info{% endif %}" 
                    role="progressbar" 
                    style="width: {{ prediction.confidence }}%"
                    aria-valuenow="{{ prediction.confidence }}" 
                    aria-valuemin="0" 
                    aria-valuemax="100">
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- Doctor Feedback Section -->
            <div class="feedback-section" id="feedbackSection">
              <h4><i class="fas fa-user-md"></i> Doctor Validation Required</h4>
              <p class="mb-3">Please verify if the AI prediction is correct:</p>
              
              <div class="feedback-buttons">
                <button class="btn-correct" onclick="markAsCorrect()">
                  <i class="fas fa-check-circle"></i> Prediction is Correct
                </button>
                <button class="btn-incorrect" onclick="showCorrectionForm()">
                  <i class="fas fa-times-circle"></i> Prediction is Incorrect
                </button>
              </div>

              <!-- Correction Form (Hidden initially) -->
              <div class="correction-form" id="correctionForm" style="display: none;">
                <h5 class="mb-3"><i class="fas fa-edit"></i> Please Select the Correct Diagnosis:</h5>
                
                <div id="classOptions">
                  {% for label in class_labels %}
                  <div class="class-option" data-class-id="{{ loop.index0 }}" data-class-name="{{ label }}" onclick="selectClass(this)">
                    <i class="fas fa-circle-notch"></i> <strong>{{ label }}</strong>
                  </div>
                  {% endfor %}
                </div>

                <div class="mt-3">
                  <label for="doctorNotes"><strong>Additional Notes (Optional):</strong></label>
                  <textarea class="doctor-notes" id="doctorNotes" placeholder="Enter any observations, reasons for correction, or additional comments..."></textarea>
                </div>

                <div class="mt-3">
                  <label for="doctorId"><strong>Doctor ID (Optional):</strong></label>
                  <input type="text" class="form-control" id="doctorId" placeholder="Enter your doctor ID or name">
                </div>

                <button class="submit-feedback-btn" onclick="submitCorrection()">
                  <i class="fas fa-paper-plane"></i> Submit Correction
                </button>
              </div>

              <!-- Success Message -->
              <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> <strong>Thank you!</strong> Your feedback has been recorded and will be used to improve the model.
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="text-center mt-4">
          <a href="/" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-upload"></i> Analyze Another Image
          </a>
          <a href="/dashboard" class="btn btn-outline-info btn-lg ms-3">
            <i class="fas fa-chart-line"></i> View Dashboard
          </a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>
    
    <script>
      const predictionId = {{ prediction_id }};
      let selectedClassId = null;
      let selectedClassName = null;

      function markAsCorrect() {
        if (confirm('Are you sure the AI prediction is correct?')) {
          submitFeedback(true, null, null);
        }
      }

      function showCorrectionForm() {
        document.getElementById('correctionForm').style.display = 'block';
      }

      function selectClass(element) {
        // Remove previous selection
        document.querySelectorAll('.class-option').forEach(opt => {
          opt.classList.remove('selected');
          opt.querySelector('i').className = 'fas fa-circle-notch';
        });
        
        // Mark as selected
        element.classList.add('selected');
        element.querySelector('i').className = 'fas fa-check-circle';
        
        selectedClassId = parseInt(element.getAttribute('data-class-id'));
        selectedClassName = element.getAttribute('data-class-name');
      }

      function submitCorrection() {
        if (selectedClassId === null) {
          alert('Please select the correct diagnosis before submitting.');
          return;
        }

        const doctorNotes = document.getElementById('doctorNotes').value;
        const doctorId = document.getElementById('doctorId').value || 'anonymous';

        submitFeedback(false, selectedClassId, selectedClassName, doctorNotes, doctorId);
      }

      function submitFeedback(isCorrect, correctClass, correctClassName, doctorNotes = '', doctorId = 'anonymous') {
        const data = {
          prediction_id: predictionId,
          is_correct: isCorrect,
          correct_class: correctClass,
          correct_class_name: correctClassName,
          doctor_notes: doctorNotes,
          doctor_id: doctorId
        };

        fetch('/submit_feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Hide feedback section
            document.getElementById('feedbackSection').style.display = 'none';
            
            // Show success message
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            successMsg.innerHTML = `<i class="fas fa-check-circle"></i> <strong>Thank you!</strong> ${data.message}`;
            
            // Scroll to success message
            successMsg.scrollIntoView({ behavior: 'smooth' });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while submitting feedback. Please try again.');
        });
      }
    </script>
  </body>
</html>
